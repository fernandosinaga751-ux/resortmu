<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ¬∑ GKPS Resort Medan Utara</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --cream:#FAF6EE;--parchment:#F2E8D5;--parchment2:#E8D9BC;
  --burgundy:#6E1A33;--burgundy-dark:#4A0F22;--burgundy-light:#95294A;
  --navy:#1C3557;--navy-light:#274875;
  --gold:#B8902A;--gold-light:#D4AE52;
  --text:#1E0D08;--text-mid:#4A2E1F;--text-muted:#7A6252;
  --white:#FFFDF9;--shadow:rgba(30,13,8,0.13);
  --green:#2E7D32;--red:#C62828;
  --sidebar-w:260px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'EB Garamond',Georgia,serif;background:#F0EBE3;color:var(--text);min-height:100vh;}

/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
#login-screen{
  display:flex;align-items:center;justify-content:center;
  min-height:100vh;
  background:linear-gradient(145deg,var(--burgundy-dark) 0%,var(--burgundy) 60%,#9B2B48 100%);
  padding:20px;
}
#login-screen::before{
  content:'‚úù';position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  font-size:60vw;color:rgba(255,255,255,.03);pointer-events:none;z-index:0;
}
.login-box{
  position:relative;z-index:1;
  background:var(--white);padding:48px 44px;
  width:100%;max-width:420px;
  box-shadow:0 24px 80px rgba(0,0,0,.35);
  border-top:5px solid var(--gold);
  border-radius:8px;
}
.login-cross{font-size:40px;color:var(--burgundy);text-align:center;margin-bottom:16px;}
.login-title{font-family:'Cinzel',serif;font-size:20px;font-weight:700;color:var(--burgundy-dark);text-align:center;margin-bottom:4px;}
.login-sub{font-size:14px;color:var(--text-muted);text-align:center;font-style:italic;margin-bottom:32px;}
.login-form{display:flex;flex-direction:column;gap:16px;}
.login-fg{display:flex;flex-direction:column;gap:7px;}
.login-fg label{font-family:'Cinzel',serif;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);}
.login-fg input{
  font-family:'EB Garamond',serif;font-size:16px;color:var(--text);
  background:var(--cream);border:1px solid var(--parchment2);
  padding:12px 16px;outline:none;transition:border-color .2s;border-radius:4px;
}
.login-fg input:focus{border-color:var(--burgundy);}
.login-btn{
  font-family:'Cinzel',serif;font-size:11px;letter-spacing:3px;text-transform:uppercase;
  color:var(--cream);background:var(--burgundy);border:none;
  padding:14px;cursor:pointer;transition:all .2s;margin-top:6px;border-radius:4px;
}
.login-btn:hover{background:var(--burgundy-light);}
.login-err{
  font-size:13px;color:var(--red);text-align:center;font-style:italic;
  background:#FFF0F0;border:1px solid rgba(198,40,40,.2);padding:8px 14px;
  display:none;border-radius:4px;
}
.login-err.show{display:block;}
.login-back{text-align:center;margin-top:18px;font-size:13px;}
.login-back a{color:var(--burgundy);text-decoration:none;font-style:italic;}
.login-back a:hover{text-decoration:underline;}
.login-default-hint{
  font-size:12px;color:var(--text-muted);text-align:center;
  font-style:italic;margin-top:10px;opacity:.7;
}

/* ‚îÄ‚îÄ ADMIN SHELL ‚îÄ‚îÄ */
#admin-shell{display:none;min-height:100vh;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{
  position:fixed;top:0;left:0;bottom:0;width:var(--sidebar-w);
  background:var(--burgundy-dark);
  border-right:3px solid var(--gold);
  display:flex;flex-direction:column;
  z-index:200;overflow-y:auto;
}
.sb-brand{
  padding:24px 22px 20px;
  border-bottom:1px solid rgba(184,144,42,.2);
}
.sb-cross{font-size:28px;color:var(--gold-light);margin-bottom:8px;display:block;}
.sb-title{font-family:'Cinzel',serif;font-size:13px;font-weight:700;color:var(--cream);line-height:1.3;}
.sb-sub{font-size:11px;color:rgba(255,255,255,.4);font-style:italic;margin-top:3px;}

.sb-section{padding:16px 0 8px;}
.sb-section-label{
  font-family:'Cinzel',serif;font-size:8px;letter-spacing:4px;
  text-transform:uppercase;color:rgba(184,144,42,.6);
  padding:0 22px 8px;
}
.sb-link{
  display:flex;align-items:center;gap:12px;
  padding:10px 22px;cursor:pointer;
  font-family:'Cinzel',serif;font-size:11px;letter-spacing:1px;
  color:rgba(255,255,255,.55);transition:all .2s;
  border-left:3px solid transparent;
}
.sb-link:hover{color:var(--cream);background:rgba(255,255,255,.05);}
.sb-link.active{color:var(--gold-light);background:rgba(184,144,42,.1);border-left-color:var(--gold-light);}
.sb-link .sb-ico{font-size:16px;min-width:20px;text-align:center;}

.sb-footer{margin-top:auto;padding:16px 22px;border-top:1px solid rgba(255,255,255,.08);}
.sb-logout{
  width:100%;font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;text-transform:uppercase;
  color:rgba(255,255,255,.45);background:none;border:1px solid rgba(255,255,255,.15);
  padding:9px;cursor:pointer;transition:all .2s;border-radius:4px;
}
.sb-logout:hover{color:var(--cream);border-color:rgba(255,255,255,.4);}
.sb-view-web{
  display:block;text-align:center;margin-bottom:10px;
  font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;text-transform:uppercase;
  color:var(--gold-light);border:1px solid rgba(184,144,42,.35);
  padding:8px;text-decoration:none;transition:all .2s;border-radius:4px;
}
.sb-view-web:hover{background:rgba(184,144,42,.12);}

/* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
.admin-main{
  margin-left:var(--sidebar-w);
  min-height:100vh;
  background:#F0EBE3;
}
.admin-topbar{
  background:var(--white);border-bottom:1px solid var(--parchment2);
  padding:16px 40px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;
  box-shadow:0 2px 8px var(--shadow);
}
.topbar-title{font-family:'Cinzel',serif;font-size:16px;font-weight:700;color:var(--burgundy-dark);}
.topbar-user{
  display:flex;align-items:center;gap:10px;
  font-size:14px;color:var(--text-muted);font-style:italic;
}
.user-avatar{
  width:36px;height:36px;border-radius:50%;
  background:var(--burgundy);display:flex;align-items:center;
  justify-content:center;font-family:'Cinzel',serif;font-size:13px;
  font-weight:700;color:var(--cream);
}

/* Panels */
.admin-panel{display:none;padding:36px 40px;animation:fadeIn .35s ease;}
.admin-panel.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

.panel-header{margin-bottom:30px;}
.panel-header h2{font-family:'Cinzel',serif;font-size:clamp(18px,2.5vw,26px);font-weight:700;color:var(--burgundy-dark);}
.panel-header h2 em{font-style:normal;color:var(--gold);}
.panel-header p{font-size:15px;color:var(--text-muted);font-style:italic;margin-top:6px;}

/* Stats row */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:36px;}
.stat-card{background:var(--white);border:1px solid var(--parchment2);padding:22px;text-align:center;border-top:4px solid var(--burgundy);border-radius:4px;}
.stat-num{font-family:'Cinzel',serif;font-size:32px;font-weight:700;color:var(--burgundy);line-height:1;}
.stat-label{font-size:13px;color:var(--text-muted);font-style:italic;margin-top:6px;}

/* Cards grid for dashboard */
.dash-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;}
.dash-card{
  background:var(--white);border:1px solid var(--parchment2);
  padding:24px;cursor:pointer;
  border-left:4px solid var(--burgundy-light);
  transition:all .2s;border-radius:4px;
}
.dash-card:hover{border-color:var(--burgundy);transform:translateX(4px);}
.dash-card-icon{font-size:28px;margin-bottom:12px;}
.dash-card-title{font-family:'Cinzel',serif;font-size:14px;font-weight:700;color:var(--burgundy);margin-bottom:6px;}
.dash-card-desc{font-size:13px;color:var(--text-muted);font-style:italic;}

/* Forms */
.form-card{background:var(--white);border:1px solid var(--parchment2);padding:28px;border-top:4px solid var(--burgundy);box-shadow:0 2px 10px var(--shadow);max-width:720px;margin-bottom:24px;border-radius:4px;}
.form-card h3{font-family:'Cinzel',serif;font-size:13px;letter-spacing:3px;text-transform:uppercase;color:var(--burgundy);margin-bottom:22px;display:flex;align-items:center;gap:10px;}
.form-card h3::before{content:'‚ú¶';color:var(--gold);font-size:10px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
.form-row.full{grid-template-columns:1fr;}
.form-row.three{grid-template-columns:1fr 1fr 1fr;}
.fg{display:flex;flex-direction:column;gap:7px;}
.fg label{font-family:'Cinzel',serif;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);}
.fg label .req{color:var(--red);margin-left:2px;}
.fg input,.fg select,.fg textarea{
  font-family:'EB Garamond',serif;font-size:14px;color:var(--text);
  background:var(--cream);border:1px solid var(--parchment2);
  padding:10px 14px;outline:none;transition:border-color .2s;width:100%;border-radius:4px;
}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--burgundy);}
.fg textarea{resize:vertical;min-height:90px;}
.fg select option{background:var(--white);}
.btn-primary{
  font-family:'Cinzel',serif;font-size:10px;letter-spacing:3px;text-transform:uppercase;
  color:var(--cream);background:var(--burgundy);border:none;
  padding:12px 28px;cursor:pointer;transition:all .2s;border-radius:4px;
}
.btn-primary:hover{background:var(--burgundy-light);box-shadow:0 4px 16px rgba(110,26,51,.25);}
.btn-secondary{
  font-family:'Cinzel',serif;font-size:10px;letter-spacing:3px;text-transform:uppercase;
  color:var(--burgundy);background:transparent;border:1px solid rgba(110,26,51,.3);
  padding:11px 22px;cursor:pointer;transition:all .2s;margin-left:10px;border-radius:4px;
}
.btn-secondary:hover{border-color:var(--burgundy);background:rgba(110,26,51,.06);}
.btn-danger{
  font-family:'Cinzel',serif;font-size:9px;letter-spacing:2px;text-transform:uppercase;
  color:var(--red);background:transparent;border:1px solid rgba(198,40,40,.3);
  padding:8px 16px;cursor:pointer;transition:all .2s;border-radius:4px;
}
.btn-danger:hover{background:rgba(198,40,40,.06);}

/* Photo upload */
.photo-upload-wrap{
  border:2px dashed var(--parchment2);padding:24px;text-align:center;
  cursor:pointer;transition:all .2s;position:relative;background:var(--cream);border-radius:4px;
}
.photo-upload-wrap:hover{border-color:var(--burgundy-light);background:var(--parchment);}
.photo-upload-wrap input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.photo-icon{font-size:32px;opacity:.3;margin-bottom:8px;display:block;}
.photo-hint{font-size:13px;color:var(--text-muted);font-style:italic;}
.photo-preview{
  max-width:100%;max-height:160px;object-fit:cover;margin-top:10px;
  border:1px solid var(--parchment2);display:none;border-radius:4px;
}

/* Lists */
.item-list{display:flex;flex-direction:column;gap:12px;max-width:760px;}
.item-card{
  background:var(--white);border:1px solid var(--parchment2);
  padding:16px 18px;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:14px;
  box-shadow:0 1px 4px var(--shadow);transition:all .2s;border-radius:4px;
}
.item-card:hover{border-color:var(--burgundy-light);}
.item-thumb{
  width:70px;height:60px;object-fit:cover;
  border:1px solid var(--parchment2);border-radius:4px;
}
.item-thumb-empty{
  width:70px;height:60px;background:var(--parchment);
  display:flex;align-items:center;justify-content:center;font-size:22px;opacity:.35;border-radius:4px;
}
.item-date{font-family:'Cinzel',serif;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--gold);margin-bottom:5px;}
.item-title{font-size:15px;color:var(--text);font-weight:600;}
.item-meta{font-size:12px;color:var(--text-muted);font-style:italic;margin-top:2px;}
.item-actions{display:flex;gap:8px;align-items:center;}

/* Pengurus grid with photos */
.pengurus-grid-admin{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px;margin-top:24px;}
.pengurus-card-admin{
  background:var(--white);border:1px solid var(--parchment2);
  padding:20px;text-align:center;border-radius:8px;
  box-shadow:0 2px 8px var(--shadow);transition:all .3s;
}
.pengurus-card-admin:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(110,26,51,.15);}
.pengurus-photo{
  width:100px;height:100px;border-radius:50%;
  overflow:hidden;margin:0 auto 16px;
  border:3px solid var(--gold-light);
  background:linear-gradient(135deg,var(--burgundy),var(--burgundy-light));
  display:flex;align-items:center;justify-content:center;
}
.pengurus-photo img{width:100%;height:100%;object-fit:cover;}
.pengurus-photo-initial{
  font-family:'Cinzel',serif;font-size:36px;font-weight:700;color:var(--cream);
}
.pengurus-jabatan{
  font-family:'Cinzel',serif;font-size:9px;letter-spacing:2px;
  text-transform:uppercase;color:var(--burgundy-light);margin-bottom:6px;
}
.pengurus-nama{font-size:16px;font-weight:600;color:var(--text);margin-bottom:4px;}
.pengurus-info{font-size:12px;color:var(--text-muted);font-style:italic;}
.pengurus-actions{display:flex;gap:8px;justify-content:center;margin-top:12px;}

/* File list admin */
.file-list-admin{display:flex;flex-direction:column;gap:12px;max-width:700px;margin-top:20px;}
.fa-item{
  background:var(--white);border:1px solid var(--parchment2);
  padding:14px 18px;display:flex;align-items:center;gap:14px;
  box-shadow:0 1px 4px var(--shadow);border-radius:4px;
}
.fa-icon{font-size:26px;min-width:34px;text-align:center;}
.fa-info{flex:1;}
.fa-name{font-size:15px;color:var(--text);font-weight:600;}
.fa-meta{font-size:12px;color:var(--text-muted);font-style:italic;}
.fa-del{background:none;border:none;color:rgba(198,40,40,.4);font-size:17px;cursor:pointer;transition:color .2s;padding:3px 6px;}
.fa-del:hover{color:var(--red);}

/* Upload zone admin */
.upload-zone-admin{
  border:2px dashed var(--parchment2);padding:36px;text-align:center;
  cursor:pointer;transition:all .2s;max-width:680px;position:relative;background:var(--cream);border-radius:4px;
}
.upload-zone-admin:hover,.upload-zone-admin.drag{border-color:var(--burgundy-light);background:var(--parchment);}
.upload-zone-admin input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.uz-icon{font-size:34px;opacity:.3;margin-bottom:10px;display:block;}
.uz-text{font-family:'Cinzel',serif;font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);}
.uz-hint{font-size:13px;color:var(--text-muted);font-style:italic;margin-top:6px;}

/* Toast */
.toast{
  position:fixed;bottom:30px;right:30px;z-index:9999;
  background:var(--burgundy);color:var(--cream);
  font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;text-transform:uppercase;
  padding:14px 24px;
  box-shadow:0 8px 28px rgba(0,0,0,.25);
  transform:translateY(80px);opacity:0;transition:all .3s;border-radius:4px;
}
.toast.show{transform:translateY(0);opacity:1;}
.toast.green{background:#2E7D32;}

/* Alert */
.alert-success{background:#E8F5E9;border:1px solid rgba(46,125,50,.3);color:var(--green);padding:10px 16px;font-size:14px;margin-bottom:16px;display:none;border-radius:4px;}
.alert-success.show{display:block;}
/* Photo slots */
.photo-slot{
  position:relative;height:100px;background:var(--cream);
  border:2px dashed var(--parchment2);border-radius:4px;
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;cursor:pointer;overflow:hidden;
  transition:all .2s;
}
.photo-slot:hover{border-color:var(--burgundy-light);background:var(--parchment);}
.photo-slot.filled{border-style:solid;border-color:var(--gold);}

/* Select wrapper */
.select-wrapper{position:relative;max-width:340px;margin-bottom:24px;}
.select-wrapper select{
  width:100%;font-family:'Cinzel',serif;font-size:12px;color:var(--text);
  background:var(--white);border:1px solid var(--parchment2);
  padding:12px 16px;outline:none;transition:border-color .2s;
  appearance:none;cursor:pointer;letter-spacing:1px;border-radius:4px;
}
.select-wrapper select:focus{border-color:var(--burgundy);}
.select-wrapper::after{content:'‚ñæ';position:absolute;right:14px;top:50%;transform:translateY(-50%);color:var(--burgundy);pointer-events:none;}

/* Responsive */
@media(max-width:900px){
  :root{--sidebar-w:200px;}
  .admin-panel{padding:24px 22px;}
  .admin-topbar{padding:14px 22px;}
  .stats-row{grid-template-columns:1fr 1fr;}
  .form-row{grid-template-columns:1fr;}
  .form-row.three{grid-template-columns:1fr;}
}
@media(max-width:640px){
  .sidebar{display:none;}
  .admin-main{margin-left:0;}
}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="../assets/js/firebase-db.js"></script>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê -->
<div id="login-screen">
  <div class="login-box">
    <img src="../assets/images/logo-gkps2.png" style="width:64px;height:64px;object-fit:contain;display:block;margin:0 auto 12px;" alt="Logo GKPS">
    <div class="login-title">Admin Panel</div>
    <div class="login-sub">GKPS Resort Medan Utara</div>
    <div class="login-err" id="login-err">Password salah. Silakan coba lagi.</div>
    <div class="login-form">
      <div class="login-fg">
        <label>Username</label>
        <input type="text" id="admin-user" value="admin" readonly style="opacity:.6;">
      </div>
      <div class="login-fg">
        <label>Password <span style="color:rgba(0,0,0,.3);font-size:11px;">(default: admin123)</span></label>
        <input type="password" id="admin-pass" placeholder="Masukkan password" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <button class="login-btn" onclick="doLogin()">‚úù Masuk ke Admin</button>
    </div>
    <div class="login-back"><a href="../index.html">‚Üê Kembali ke Website</a></div>
    <div class="login-default-hint">Password default: <strong>admin123</strong> ‚Äî Harap ganti setelah login pertama</div>
  </div>
</div>

<!-- ‚ïê‚ïê ADMIN SHELL ‚ïê‚ïê -->
<div id="admin-shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sb-brand">
      <img src="../assets/images/logo-gkps2.png" style="width:48px;height:48px;object-fit:contain;display:block;margin-bottom:8px;" alt="Logo GKPS">
      <div class="sb-title">GKPS Resort<br>Medan Utara</div>
      <div class="sb-sub">Panel Administrasi</div>
    </div>

    <div class="sb-section">
      <div class="sb-section-label">Dashboard</div>
      <div class="sb-link active" onclick="showPanel('dashboard',this)"><span class="sb-ico">üè†</span>Beranda Admin</div>
    </div>

    <div class="sb-section">
      <div class="sb-section-label">Konten Website</div>
      <div class="sb-link" onclick="showPanel('kegiatan-resort',this)"><span class="sb-ico">üìÖ</span>Kegiatan Resort</div>
      <div class="sb-link" onclick="showPanel('kegiatan-jemaat',this)"><span class="sb-ico">‚õ™</span>Kegiatan Jemaat</div>
      <div class="sb-link" onclick="showPanel('kegiatan-seksi',this)"><span class="sb-ico">üèõÔ∏è</span>Kegiatan Seksi Resort</div>
    </div>

    <div class="sb-section">
      <div class="sb-section-label">Manajemen Data</div>
      <div class="sb-link" onclick="showPanel('pengurus-resort',this)"><span class="sb-ico">üë§</span>Pengurus Resort</div>
      <div class="sb-link" onclick="showPanel('file-unduhan',this)"><span class="sb-ico">üìÇ</span>File Unduhan</div>
      <div class="sb-link" onclick="showPanel('sekretariat',this)"><span class="sb-ico">üìç</span>Info Sekretariat</div>
      <div class="sb-link" onclick="showPanel('statistik-pengunjung',this)"><span class="sb-ico">üëÅ</span>Statistik Pengunjung</div>
    </div>

    <div class="sb-section">
      <div class="sb-section-label">Akun</div>
      <div class="sb-link" onclick="showPanel('settings',this)"><span class="sb-ico">‚öôÔ∏è</span>Pengaturan</div>
    </div>

    <div class="sb-footer">
      <a href="../index.html" class="sb-view-web" target="_blank">üåê Lihat Website</a>
      <button class="sb-logout" onclick="doLogout()">Keluar ‚Ü©</button>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="admin-main">
    <div class="admin-topbar">
      <div class="topbar-title" id="topbar-title">Dashboard</div>
      <div id="fb-status" style="font-size:12px;font-style:italic;color:var(--text-muted);padding:4px 16px;background:var(--cream);border-radius:20px;"></div><div class="topbar-user">
        <span>Administrator</span>
        <div class="user-avatar">A</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL: DASHBOARD ‚îÄ‚îÄ -->
    <div id="panel-dashboard" class="admin-panel active">
      <div class="panel-header">
        <h2>Selamat Datang, <em>Administrator</em></h2>
        <p>Kelola konten website GKPS Resort Medan Utara dari sini</p>
      </div>
      <div class="stats-row">
        <div class="stat-card"><div class="stat-num" id="stat-keg-resort">0</div><div class="stat-label">Kegiatan Resort</div></div>
        <div class="stat-card" style="border-top-color:var(--navy)"><div class="stat-num" id="stat-keg-jemaat" style="color:var(--navy)">0</div><div class="stat-label">Kegiatan Jemaat</div></div>
        <div class="stat-card" style="border-top-color:var(--gold)"><div class="stat-num" id="stat-files" style="color:var(--gold)">0</div><div class="stat-label">File Tersedia</div></div>
        <div class="stat-card" style="border-top-color:var(--green)"><div class="stat-num" id="stat-pengurus" style="color:var(--green)">0</div><div class="stat-label">Pengurus Resort</div></div>
        <div class="stat-card" style="border-top-color:#7c3aed"><div class="stat-num" id="stat-visitors-total" style="color:#7c3aed">0</div><div class="stat-label">Total Pengunjung</div></div>
        <div class="stat-card" style="border-top-color:#0891b2"><div class="stat-num" id="stat-visitors-today" style="color:#0891b2">0</div><div class="stat-label">Pengunjung Hari Ini</div></div>
      </div>
      <h3 style="font-family:'Cinzel',serif;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);margin-bottom:18px;">Menu Cepat</h3>
      <div class="dash-cards">
        <div class="dash-card" onclick="showPanel('kegiatan-resort',document.querySelector('.sb-link:nth-child(2)'))">
          <div class="dash-card-icon">üìÖ</div>
          <div class="dash-card-title">Tambah Kegiatan Resort</div>
          <div class="dash-card-desc">Tambah program dengan foto, lokasi dan deskripsi</div>
        </div>
        <div class="dash-card" onclick="showPanel('kegiatan-jemaat',null)">
          <div class="dash-card-icon">‚õ™</div>
          <div class="dash-card-title">Kegiatan per Jemaat</div>
          <div class="dash-card-desc">Tambah kegiatan untuk tiap jemaat</div>
        </div>
        <div class="dash-card" onclick="showPanel('file-unduhan',null)">
          <div class="dash-card-icon">üìÇ</div>
          <div class="dash-card-title">Upload File Unduhan</div>
          <div class="dash-card-desc">Upload dokumen untuk seksi resort</div>
        </div>
        <div class="dash-card" onclick="showPanel('pengurus-resort',null)">
          <div class="dash-card-icon">üë§</div>
          <div class="dash-card-title">Pengurus Resort</div>
          <div class="dash-card-desc">Tambah & kelola data pengurus dengan foto</div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL: KEGIATAN RESORT ‚îÄ‚îÄ -->
    <div id="panel-kegiatan-resort" class="admin-panel">
      <div class="panel-header">
        <h2>Kegiatan <em>Resort</em></h2>
        <p>Tambah, edit, atau hapus kegiatan resort yang tampil di halaman utama</p>
      </div>

      <div class="form-card">
        <h3>Tambah Kegiatan Baru</h3>
        <div class="form-row">
          <div class="fg"><label>Judul Kegiatan<span class="req">*</span></label><input type="text" id="kr-judul" placeholder="cth. Kebaktian Paskah 2025"></div>
          <div class="fg"><label>Tanggal<span class="req">*</span></label><input type="date" id="kr-tgl"></div>
        </div>
        <div class="form-row three">
          <div class="fg"><label>Waktu</label><input type="time" id="kr-waktu"></div>
          <div class="fg" style="grid-column:span 2"><label>Lokasi</label><input type="text" id="kr-lokasi" placeholder="cth. Aula GKPS Kampung Durian"></div>
        </div>
        <div class="form-row full">
          <div class="fg"><label>Deskripsi</label><textarea id="kr-desc" placeholder="Deskripsi singkat kegiatan..."></textarea></div>
        </div>
        <div class="form-row full">
          <div class="fg">
            <label>Foto Kegiatan <span style="color:var(--text-muted);font-size:11px;">(maks 6 foto, klik untuk pilih)</span></label>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px;">
              <div id="kr-slot-0" class="photo-slot" onclick="triggerFotoInput(0)">
                <input type="file" id="kr-foto-0" accept="image/*" style="display:none" onchange="handleSlotFoto(this,0,'resort')">
                <span style="font-size:24px;opacity:.4">üì∑</span>
                <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Foto 1 (Utama)</div>
                <img id="kr-prev-0" style="display:none;width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:4px;" alt="">
              </div>
              <div id="kr-slot-1" class="photo-slot" onclick="triggerFotoInput(1)">
                <input type="file" id="kr-foto-1" accept="image/*" style="display:none" onchange="handleSlotFoto(this,1,'resort')">
                <span style="font-size:24px;opacity:.4">üì∑</span>
                <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Foto 2</div>
                <img id="kr-prev-1" style="display:none;width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:4px;" alt="">
              </div>
              <div id="kr-slot-2" class="photo-slot" onclick="triggerFotoInput(2)">
                <input type="file" id="kr-foto-2" accept="image/*" style="display:none" onchange="handleSlotFoto(this,2,'resort')">
                <span style="font-size:24px;opacity:.4">üì∑</span>
                <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Foto 3</div>
                <img id="kr-prev-2" style="display:none;width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:4px;" alt="">
              </div>
              <div id="kr-slot-3" class="photo-slot" onclick="triggerFotoInput(3)">
                <input type="file" id="kr-foto-3" accept="image/*" style="display:none" onchange="handleSlotFoto(this,3,'resort')">
                <span style="font-size:24px;opacity:.4">üì∑</span>
                <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Foto 4</div>
                <img id="kr-prev-3" style="display:none;width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:4px;" alt="">
              </div>
              <div id="kr-slot-4" class="photo-slot" onclick="triggerFotoInput(4)">
                <input type="file" id="kr-foto-4" accept="image/*" style="display:none" onchange="handleSlotFoto(this,4,'resort')">
                <span style="font-size:24px;opacity:.4">üì∑</span>
                <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Foto 5</div>
                <img id="kr-prev-4" style="display:none;width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:4px;" alt="">
              </div>
              <div id="kr-slot-5" class="photo-slot" onclick="triggerFotoInput(5)">
                <input type="file" id="kr-foto-5" accept="image/*" style="display:none" onchange="handleSlotFoto(this,5,'resort')">
                <span style="font-size:24px;opacity:.4">üì∑</span>
                <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Foto 6</div>
                <img id="kr-prev-5" style="display:none;width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:4px;" alt="">
              </div>
            </div>
          </div>
        </div>
        <button class="btn-primary" onclick="saveKegiatanResort()">Simpan Kegiatan</button>
        <button class="btn-secondary" onclick="clearKegForm('resort')">Bersihkan</button>
      </div>

      <h3 style="font-family:'Cinzel',serif;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);margin-bottom:16px;">Daftar Kegiatan Resort</h3>
      <div class="item-list" id="kr-list"></div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL: KEGIATAN JEMAAT ‚îÄ‚îÄ -->
    <div id="panel-kegiatan-jemaat" class="admin-panel">
      <div class="panel-header">
        <h2>Kegiatan <em>Jemaat</em></h2>
        <p>Tambah kegiatan untuk masing-masing jemaat</p>
      </div>
      <div class="select-wrapper">
        <select id="kj-select" onchange="loadJemaatKeg()">
          <option value="">‚Äî Pilih Jemaat ‚Äî</option>
          <option value="kampung-durian">GKPS Kampung Durian</option>
          <option value="krakatau">GKPS Krakatau</option>
          <option value="martubung">GKPS Martubung</option>
          <option value="belawan">GKPS Belawan</option>
          <option value="batang-sere">Pos Persiapan GKPS Batang Sere</option>
        </select>
      </div>

      <div id="kj-form-wrap" style="display:none;">
        <div class="form-card">
          <h3 id="kj-form-title">Tambah Kegiatan Jemaat</h3>
          <div class="form-row">
            <div class="fg"><label>Judul Kegiatan<span class="req">*</span></label><input type="text" id="kj-judul" placeholder="cth. Kebaktian Natal"></div>
            <div class="fg"><label>Tanggal<span class="req">*</span></label><input type="date" id="kj-tgl"></div>
          </div>
          <div class="form-row three">
            <div class="fg"><label>Waktu</label><input type="time" id="kj-waktu"></div>
            <div class="fg" style="grid-column:span 2"><label>Lokasi</label><input type="text" id="kj-lokasi" placeholder="cth. Gedung Gereja"></div>
          </div>
          <div class="form-row full">
            <div class="fg"><label>Deskripsi</label><textarea id="kj-desc" placeholder="Deskripsi singkat..."></textarea></div>
          </div>
          <div class="form-row full">
            <div class="fg">
              <label>Foto Kegiatan</label>
              <div class="photo-upload-wrap">
                <input type="file" id="kj-foto-input" accept="image/*" onchange="previewPhoto('kj-foto-input','kj-photo-preview')">
                <span class="photo-icon">üñºÔ∏è</span>
                <div class="photo-hint">Klik untuk pilih foto (maks 5 MB)</div>
                <img id="kj-photo-preview" class="photo-preview" alt="">
              </div>
            </div>
          </div>
          <button class="btn-primary" onclick="saveKegiatanJemaat()">Simpan Kegiatan</button>
          <button class="btn-secondary" onclick="clearKegForm('jemaat')">Bersihkan</button>
        </div>

        <h3 style="font-family:'Cinzel',serif;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);margin-bottom:16px;" id="kj-list-title">Daftar Kegiatan</h3>
        <div class="item-list" id="kj-list"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL: KEGIATAN SEKSI RESORT ‚îÄ‚îÄ -->
    <div id="panel-kegiatan-seksi" class="admin-panel">
      <div class="panel-header">
        <h2>Kegiatan <em>Seksi Resort</em></h2>
        <p>Tambah kegiatan untuk seksi-seksi Resort Medan Utara</p>
      </div>
      <div class="select-wrapper">
        <select id="ks-select" onchange="loadSeksiKeg()">
          <option value="">‚Äî Pilih Seksi Resort ‚Äî</option>
          <option value="bapa">Seksi Bapa</option>
          <option value="inang">Seksi Inang</option>
          <option value="namaposo">Seksi Namaposo</option>
          <option value="sekolah-minggu">Seksi Sekolah Minggu</option>
        </select>
      </div>
      <div id="ks-form-wrap" style="display:none;">
        <div class="form-card">
          <h3 id="ks-form-title">Tambah Kegiatan Seksi</h3>
          <div class="form-row">
            <div class="fg"><label>Judul Kegiatan<span class="req">*</span></label><input type="text" id="ks-judul" placeholder="cth. Rapat Pengurus Seksi"></div>
            <div class="fg"><label>Tanggal<span class="req">*</span></label><input type="date" id="ks-tgl"></div>
          </div>
          <div class="form-row three">
            <div class="fg"><label>Waktu</label><input type="time" id="ks-waktu"></div>
            <div class="fg" style="grid-column:span 2"><label>Lokasi</label><input type="text" id="ks-lokasi" placeholder="cth. GKPS Kampung Durian"></div>
          </div>
          <div class="form-row full">
            <div class="fg"><label>Deskripsi</label><textarea id="ks-desc" placeholder="Deskripsi singkat..."></textarea></div>
          </div>
          <div class="form-row full">
            <div class="fg">
              <label>Foto Kegiatan</label>
              <div class="photo-upload-wrap">
                <input type="file" id="ks-foto-input" accept="image/*" onchange="previewPhoto('ks-foto-input','ks-photo-preview')">
                <span class="photo-icon">üñºÔ∏è</span>
                <div class="photo-hint">Klik untuk pilih foto (maks 5 MB)</div>
                <img id="ks-photo-preview" class="photo-preview" alt="">
              </div>
            </div>
          </div>
          <button class="btn-primary" onclick="saveKegiatanSeksi()">Simpan Kegiatan</button>
          <button class="btn-secondary" onclick="clearKegForm('seksi')">Bersihkan</button>
        </div>
        <h3 style="font-family:'Cinzel',serif;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);margin-bottom:16px;">Daftar Kegiatan</h3>
        <div class="item-list" id="ks-list"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL: PENGURUS RESORT ‚îÄ‚îÄ -->
    <div id="panel-pengurus-resort" class="admin-panel">
      <div class="panel-header">
        <h2>Pengurus <em>Resort</em></h2>
        <p>Kelola data pengurus Resort GKPS Medan Utara yang tampil di halaman utama. Tambahkan foto untuk tampilan yang lebih menarik.</p>
      </div>
      
      <!-- Form Tambah Pengurus -->
      <div class="form-card">
        <h3>Tambah Pengurus Baru</h3>
        <div class="form-row">
          <div class="fg"><label>Jabatan<span class="req">*</span></label><input type="text" id="pg-jabatan" placeholder="cth. Ketua Resort"></div>
          <div class="fg"><label>Nama Lengkap<span class="req">*</span></label><input type="text" id="pg-nama" placeholder="cth. Pdt. Nama Lengkap"></div>
        </div>
        <div class="form-row">
          <div class="fg"><label>No. Telepon</label><input type="text" id="pg-telp" placeholder="08xx-xxxx-xxxx"></div>
          <div class="fg"><label>Jemaat Asal</label><input type="text" id="pg-asal" placeholder="cth. GKPS Kampung Durian"></div>
        </div>
        <div class="form-row">
          <div class="fg"><label>Periode</label><input type="text" id="pg-periode" placeholder="cth. 2023‚Äì2026"></div>
          <div class="fg"><label>Urutan Tampil</label><input type="number" id="pg-urutan" placeholder="1, 2, 3..." min="1"></div>
        </div>
        <div class="form-row full">
          <div class="fg">
            <label>Foto Pengurus</label>
            <div class="photo-upload-wrap">
              <input type="file" id="pg-foto-input" accept="image/*" onchange="previewPhoto('pg-foto-input','pg-photo-preview')">
              <span class="photo-icon">üì∑</span>
              <div class="photo-hint">Klik untuk pilih foto pengurus (maks 5 MB)</div>
              <img id="pg-photo-preview" class="photo-preview" alt="">
            </div>
          </div>
        </div>
        <button class="btn-primary" onclick="savePengurus()">Simpan Pengurus</button>
        <button class="btn-secondary" onclick="clearPengurusForm()">Bersihkan</button>
      </div>

      <!-- Daftar Pengurus -->
      <h3 style="font-family:'Cinzel',serif;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);margin-bottom:16px;">Daftar Pengurus Aktif</h3>
      <div class="pengurus-grid-admin" id="pg-grid"></div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL: FILE UNDUHAN ‚îÄ‚îÄ -->
    <div id="panel-file-unduhan" class="admin-panel">
      <div class="panel-header">
        <h2>File <em>Unduhan</em></h2>
        <p>Upload dokumen untuk seksi resort. Pengunjung dapat mengunduh file dari halaman seksi.</p>
      </div>
      <!-- Storage status indicator -->
      <div id="storage-status-bar" style="display:none;margin-bottom:18px;padding:12px 16px;border-radius:8px;font-size:13px;"></div>
      <div class="select-wrapper">
        <select id="file-seksi-select" onchange="loadFiles()">
          <option value="">‚Äî Pilih Seksi Resort ‚Äî</option>
          <option value="bapa">Seksi Bapa</option>
          <option value="inang">Seksi Inang</option>
          <option value="namaposo">Seksi Namaposo</option>
          <option value="sekolah-minggu">Seksi Sekolah Minggu</option>
        </select>
      </div>
      <div id="file-upload-wrap" style="display:none;">
        <div class="upload-zone-admin" id="file-drop-zone">
          <input type="file" id="file-input-admin" multiple onchange="handleAdminUpload(event)">
          <span class="uz-icon">üìÇ</span>
          <div class="uz-text">Klik atau Drag & Drop File</div>
          <div class="uz-hint" id="upload-hint">PDF, Word, Excel, gambar ‚Äî maks 20 MB per file</div>
        </div>
        <!-- Upload progress -->
        <div id="upload-progress-wrap" style="display:none;margin-top:14px;">
          <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px;">
            <span id="upload-progress-label">Mengupload...</span>
            <span id="upload-progress-pct" style="font-weight:700;color:var(--burgundy);">0%</span>
          </div>
          <div style="height:8px;background:var(--parchment2);border-radius:4px;overflow:hidden;">
            <div id="upload-progress-bar" style="height:8px;background:var(--burgundy);border-radius:4px;width:0%;transition:width .3s;"></div>
          </div>
        </div>
        <div class="file-list-admin" id="file-list-admin"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL: SEKRETARIAT ‚îÄ‚îÄ -->
    <div id="panel-sekretariat" class="admin-panel">
      <div class="panel-header">
        <h2>Info <em>Sekretariat</em></h2>
        <p>Perbarui informasi sekretariat Resort Medan Utara yang tampil di halaman utama</p>
      </div>
      <div class="alert-success" id="sek-alert">‚úî Informasi sekretariat berhasil disimpan!</div>
      <div class="form-card" style="max-width:680px;">
        <h3>üìç Edit Informasi Sekretariat</h3>
        <div class="form-row full"><div class="fg"><label>Alamat Sekretariat</label><textarea id="sek-alamat" placeholder="cth. Jl. Contoh No. 1, Medan Utara, Sumatera Utara" style="min-height:70px;"></textarea></div></div>
        <div class="form-row">
          <div class="fg"><label>Nomor Telepon</label><input type="text" id="sek-telp" placeholder="cth. 061-xxx-xxxx"></div>
          <div class="fg"><label>Email</label><input type="text" id="sek-email" placeholder="cth. sekretariat@gkpsmdn.org"></div>
        </div>
        <div class="form-row full"><div class="fg"><label>Jam Pelayanan</label><input type="text" id="sek-jam" placeholder="cth. Senin‚ÄìJumat, 09.00‚Äì15.00 WIB"></div></div>
        <button class="btn-primary" onclick="saveSekretariat()">Simpan Perubahan</button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL: SETTINGS ‚îÄ‚îÄ -->
    <div id="panel-settings" class="admin-panel">
      <div class="panel-header">
        <h2>Pengaturan <em>Akun</em></h2>
        <p>Ubah password akun admin untuk keamanan website</p>
      </div>
      <div class="alert-success" id="pass-alert">‚úî Password berhasil diperbarui!</div>
      <div class="form-card" style="max-width:400px;">
        <h3>Ubah Password</h3>
        <div class="form-row full">
          <div class="fg"><label>Password Lama<span class="req">*</span></label><input type="password" id="pass-old" placeholder="Password saat ini"></div>
        </div>
        <div class="form-row full">
          <div class="fg"><label>Password Baru<span class="req">*</span></label><input type="password" id="pass-new" placeholder="Minimal 6 karakter"></div>
        </div>
        <div class="form-row full">
          <div class="fg"><label>Konfirmasi Password Baru<span class="req">*</span></label><input type="password" id="pass-confirm" placeholder="Ulangi password baru"></div>
        </div>
        <button class="btn-primary" onclick="changePassword()">Simpan Password Baru</button>
        <div style="font-size:13px;color:var(--text-muted);font-style:italic;margin-top:14px;">Setelah mengubah password, gunakan password baru untuk login berikutnya.</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PANEL: STATISTIK PENGUNJUNG ‚îÄ‚îÄ -->
    <div id="panel-statistik-pengunjung" class="admin-panel">
      <div class="panel-header">
        <h2>Statistik <em>Pengunjung</em></h2>
        <p>Data siapa saja dan berapa orang yang mengunjungi website</p>
      </div>

      <!-- Summary Cards -->
      <div class="stats-row" style="margin-bottom:28px;">
        <div class="stat-card" style="border-top-color:#7c3aed">
          <div class="stat-num" id="vis-total" style="color:#7c3aed">‚Äì</div>
          <div class="stat-label">Total Pengunjung</div>
        </div>
        <div class="stat-card" style="border-top-color:#0891b2">
          <div class="stat-num" id="vis-today" style="color:#0891b2">‚Äì</div>
          <div class="stat-label">Hari Ini</div>
        </div>
        <div class="stat-card" style="border-top-color:#059669">
          <div class="stat-num" id="vis-week" style="color:#059669">‚Äì</div>
          <div class="stat-label">7 Hari Terakhir</div>
        </div>
        <div class="stat-card" style="border-top-color:#d97706">
          <div class="stat-num" id="vis-unique" style="color:#d97706">‚Äì</div>
          <div class="stat-label">Pengunjung Unik</div>
        </div>
      </div>

      <!-- Top Pages & Device Breakdown side by side -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
        <div class="form-card">
          <h3 style="font-family:'Cinzel',serif;font-size:13px;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);margin-bottom:16px;">üìÑ Halaman Terpopuler</h3>
          <div id="vis-top-pages"><em style="color:var(--text-muted)">Memuat...</em></div>
        </div>
        <div class="form-card">
          <h3 style="font-family:'Cinzel',serif;font-size:13px;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);margin-bottom:16px;">üì± Perangkat</h3>
          <div id="vis-devices"><em style="color:var(--text-muted)">Memuat...</em></div>
        </div>
      </div>

      <!-- Visitor Log Table -->
      <div class="form-card" style="padding:0;overflow:hidden;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--parchment2);">
          <h3 style="font-family:'Cinzel',serif;font-size:13px;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);margin:0;">üìã Log Kunjungan Terbaru</h3>
          <button onclick="clearVisitorLog()" style="background:none;border:1px solid #ef4444;color:#ef4444;border-radius:6px;padding:6px 14px;font-size:12px;cursor:pointer;">üóë Hapus Log</button>
        </div>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead>
              <tr style="background:var(--cream);text-align:left;">
                <th style="padding:10px 16px;font-weight:600;color:var(--text-muted);border-bottom:1px solid var(--parchment2);">Tanggal & Waktu</th>
                <th style="padding:10px 16px;font-weight:600;color:var(--text-muted);border-bottom:1px solid var(--parchment2);">Halaman</th>
                <th style="padding:10px 16px;font-weight:600;color:var(--text-muted);border-bottom:1px solid var(--parchment2);">Perangkat</th>
                <th style="padding:10px 16px;font-weight:600;color:var(--text-muted);border-bottom:1px solid var(--parchment2);">Browser</th>
                <th style="padding:10px 16px;font-weight:600;color:var(--text-muted);border-bottom:1px solid var(--parchment2);">ID Pengunjung</th>
              </tr>
            </thead>
            <tbody id="vis-log-tbody">
              <tr><td colspan="5" style="padding:24px;text-align:center;color:var(--text-muted);font-style:italic;">Memuat data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div><!-- /admin-main -->
</div><!-- /admin-shell -->

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê AUTH ‚Äî persist login, tidak redirect saat refresh ‚ïê‚ïê‚ïê */
async function doLogin(){
  const p=document.getElementById('admin-pass').value;
  const err=document.getElementById('login-err');
  const btn=document.querySelector('.login-btn');
  if(btn){btn.textContent='Memeriksa...';btn.disabled=true;}
  const ok = await AUTH.login(p);
  if(btn){btn.textContent='Masuk';btn.disabled=false;}
  if(ok){
    showAdminShell();
  }else{err.classList.add('show');document.getElementById('admin-pass').value='';}
}
function doLogout(){
  AUTH.logout();
  document.getElementById('admin-shell').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('admin-pass').value='';
  document.getElementById('login-err').classList.remove('show');
}
function showAdminShell(){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('admin-shell').style.display='block';
  loadDashStats();loadKegiatanResortList();loadPengurus();loadSekretariatForm();
  const statusEl=document.getElementById('fb-status');
  if(statusEl){
    statusEl.textContent=DB.isOnline()?'üü¢ Tersinkron ke Firebase':'üü° Mode Lokal';
    statusEl.style.color=DB.isOnline()?'#2E7D32':'#B8902A';
  }
}
// ‚îÄ‚îÄ CEK SESSION SAAT LOAD ‚Äî ini yang mencegah kembali ke login saat refresh ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded',()=>{
  if(AUTH.isLoggedIn()) showAdminShell();
});

/* ‚ïê‚ïê‚ïê PANEL NAVIGATION ‚ïê‚ïê‚ïê */
function showPanel(id,btn){
  document.querySelectorAll('.admin-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  document.querySelectorAll('.sb-link').forEach(l=>l.classList.remove('active'));
  if(btn)btn.classList.add('active');
  const titles={'dashboard':'Dashboard','kegiatan-resort':'Kegiatan Resort','kegiatan-jemaat':'Kegiatan Jemaat','kegiatan-seksi':'Kegiatan Seksi Resort','pengurus-resort':'Pengurus Resort','file-unduhan':'File Unduhan','sekretariat':'Info Sekretariat','settings':'Pengaturan Akun','statistik-pengunjung':'Statistik Pengunjung'};
  document.getElementById('topbar-title').textContent=titles[id]||id;
  loadDashStats();
  if(id==='statistik-pengunjung') loadVisitorStats();
}

/* ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê */
const $=id=>document.getElementById(id);
function toast(msg,ok=true){const t=$('toast');t.textContent=msg;t.className='toast'+(ok?' green':'');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);}
function fmtDate(s){if(!s)return'‚Äî';const d=new Date(s);return d.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'});}
function fmtBytes(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';}
function fileIcon(t){if(!t)return'üìÑ';if(t.includes('pdf'))return'üìï';if(t.includes('word')||t.includes('document'))return'üìò';if(t.includes('sheet')||t.includes('excel'))return'üìó';if(t.includes('image'))return'üñºÔ∏è';return'üìÑ';}

/* ‚ïê‚ïê‚ïê PHOTO PREVIEW ‚ïê‚ïê‚ïê */
let photoData={resort:[],jemaat:null,seksi:null,pengurus:null};

// Handle 6 slot foto kegiatan resort
function triggerFotoInput(idx){document.getElementById('kr-foto-'+idx).click();}
function handleSlotFoto(input,idx){
  const file=input.files[0];if(!file)return;
  if(file.size>8*1024*1024){toast('Foto terlalu besar (maks 8 MB)',false);return;}
  const reader=new FileReader();
  reader.onload=e=>{
    photoData.resort[idx]=e.target.result;
    const prev=$('kr-prev-'+idx);
    prev.src=e.target.result;prev.style.display='block';
    $('kr-slot-'+idx).classList.add('filled');
  };
  reader.readAsDataURL(file);
}
function previewPhoto(inputId,previewId){
  const file=document.getElementById(inputId).files[0];
  if(!file)return;
  if(file.size>5*1024*1024){toast('Foto terlalu besar (maks 5 MB)',false);return;}
  const reader=new FileReader();
  reader.onload=e=>{
    const prev=document.getElementById(previewId);
    prev.src=e.target.result;prev.style.display='block';
    if(inputId.startsWith('kj'))photoData.jemaat=e.target.result;
    else if(inputId.startsWith('ks'))photoData.seksi=e.target.result;
    else if(inputId.startsWith('pg'))photoData.pengurus=e.target.result;
  };
  reader.readAsDataURL(file);
}
function clearKegForm(type){
  if(type==='resort'){
    ['kr-judul','kr-tgl','kr-waktu','kr-lokasi','kr-desc'].forEach(i=>$(i).value='');
    photoData.resort=[];
    for(let i=0;i<6;i++){
      $('kr-prev-'+i).style.display='none';
      $('kr-slot-'+i).classList.remove('filled');
      $('kr-foto-'+i).value='';
    }
  }
  else if(type==='jemaat'){['kj-judul','kj-tgl','kj-waktu','kj-lokasi','kj-desc'].forEach(i=>$(i).value='');$('kj-photo-preview').style.display='none';photoData.jemaat=null;$('kj-foto-input').value='';}
  else if(type==='seksi'){['ks-judul','ks-tgl','ks-waktu','ks-lokasi','ks-desc'].forEach(i=>$(i).value='');$('ks-photo-preview').style.display='none';photoData.seksi=null;$('ks-foto-input').value='';}
}
function clearPengurusForm(){['pg-jabatan','pg-nama','pg-telp','pg-asal','pg-periode','pg-urutan'].forEach(i=>$(i).value='');$('pg-photo-preview').style.display='none';photoData.pengurus=null;$('pg-foto-input').value='';}

/* ‚ïê‚ïê‚ïê KEGIATAN RESORT ‚Äî Firebase ‚ïê‚ïê‚ïê */
async function saveKegiatanResort(){
  const judul=$('kr-judul').value.trim(),tgl=$('kr-tgl').value;
  if(!judul||!tgl){toast('Judul dan tanggal wajib diisi!',false);return;}
  const fotos=photoData.resort.filter(Boolean);
  const item={
    id:Date.now(),judul,tgl,
    waktu:$('kr-waktu').value,
    lokasi:$('kr-lokasi').value.trim(),
    desc:$('kr-desc').value.trim(),
    foto:fotos[0]||null,       // foto utama (untuk thumbnail di index)
    fotos:fotos                // semua foto untuk halaman detail
  };
  toast('Menyimpan kegiatan...');
  await DB.addItem('kegiatan_resort',item);
  toast('Kegiatan berhasil disimpan! ‚úì');
  clearKegForm('resort');loadKegiatanResortList();loadDashStats();
}
async function loadKegiatanResortList(){
  const list=await DB.getList('kegiatan_resort');
  const el=$('kr-list');
  if(!list.length){el.innerHTML='<div style="color:var(--text-muted);font-style:italic;padding:20px 0;">Belum ada kegiatan resort.</div>';return;}
  el.innerHTML=list.map(k=>`
    <div class="item-card">
      ${k.foto?`<img src="${k.foto}" class="item-thumb" alt="">`:`<div class="item-thumb-empty">üì∑</div>`}
      <div>
        <div class="item-date">${fmtDate(k.tgl)} ${k.waktu?'¬∑ '+k.waktu:''}</div>
        <div class="item-title">${k.judul}</div>
        <div class="item-meta">${k.lokasi?'üìç '+k.lokasi:''} ${(k.fotos&&k.fotos.length)?'üì∏ '+k.fotos.length+' foto':''}</div>
      </div>
      <div class="item-actions" style="flex-direction:column;gap:8px;">
        <a href="../kegiatan-detail.html?id=${k.id}" target="_blank" class="btn-secondary" style="text-decoration:none;font-size:9px;padding:6px 12px;">üîó Buka Halaman</a>
        <button class="btn-danger" onclick="delKegResort('${k.id}')">Hapus</button>
      </div>
    </div>`).join('');
}
async function delKegResort(id){
  if(!confirm('Hapus kegiatan ini?'))return;
  await DB.deleteItem('kegiatan_resort',id);
  loadKegiatanResortList();loadDashStats();toast('Kegiatan dihapus.');
}

/* ‚ïê‚ïê‚ïê KEGIATAN JEMAAT ‚Äî Firebase ‚ïê‚ïê‚ïê */
function loadJemaatKeg(){
  const id=$('kj-select').value;
  const wrap=$('kj-form-wrap');
  if(!id){wrap.style.display='none';return;}
  wrap.style.display='block';
  const names={'kampung-durian':'GKPS Kampung Durian','krakatau':'GKPS Krakatau','martubung':'GKPS Martubung','belawan':'GKPS Belawan','batang-sere':'Pos Persiapan Batang Sere'};
  $('kj-form-title').textContent='Tambah Kegiatan ‚Äî '+names[id];
  $('kj-list-title').textContent='Daftar Kegiatan '+names[id];
  renderJemaatKegList(id);
}
async function saveKegiatanJemaat(){
  const id=$('kj-select').value;
  if(!id){toast('Pilih jemaat dahulu!',false);return;}
  const judul=$('kj-judul').value.trim(),tgl=$('kj-tgl').value;
  if(!judul||!tgl){toast('Judul dan tanggal wajib diisi!',false);return;}
  const item={id:Date.now(),judul,tgl,waktu:$('kj-waktu').value,lokasi:$('kj-lokasi').value.trim(),desc:$('kj-desc').value.trim(),foto:photoData.jemaat||null};
  await DB.addItem('kegiatan_jemaat_'+id,item);
  toast('Kegiatan berhasil disimpan!');
  clearKegForm('jemaat');renderJemaatKegList(id);loadDashStats();
}
async function renderJemaatKegList(id){
  const list=await DB.getList('kegiatan_jemaat_'+id);
  const el=$('kj-list');
  if(!list.length){el.innerHTML='<div style="color:var(--text-muted);font-style:italic;padding:20px 0;">Belum ada kegiatan untuk jemaat ini.</div>';return;}
  el.innerHTML=list.map(k=>`
    <div class="item-card">
      ${k.foto?`<img src="${k.foto}" class="item-thumb" alt="">`:`<div class="item-thumb-empty">üì∑</div>`}
      <div>
        <div class="item-date">${fmtDate(k.tgl)} ${k.waktu?'¬∑ '+k.waktu:''}</div>
        <div class="item-title">${k.judul}</div>
        <div class="item-meta">${k.lokasi?'üìç '+k.lokasi:''} ${k.desc?'‚Äî '+k.desc.substring(0,60)+(k.desc.length>60?'...':''):''}</div>
      </div>
      <div class="item-actions"><button class="btn-danger" onclick="delJemaatKeg('${id}','${k.id}')">Hapus</button></div>
    </div>`).join('');
}
async function delJemaatKeg(jemaatId,itemId){
  if(!confirm('Hapus kegiatan ini?'))return;
  await DB.deleteItem('kegiatan_jemaat_'+jemaatId,itemId);
  renderJemaatKegList(jemaatId);loadDashStats();toast('Kegiatan dihapus.');
}

/* ‚ïê‚ïê‚ïê KEGIATAN SEKSI ‚Äî Firebase ‚ïê‚ïê‚ïê */
function loadSeksiKeg(){
  const id=$('ks-select').value;
  const wrap=$('ks-form-wrap');
  if(!id){wrap.style.display='none';return;}
  wrap.style.display='block';
  const names={'bapa':'Seksi Bapa','inang':'Seksi Inang','namaposo':'Seksi Namaposo','sekolah-minggu':'Seksi Sekolah Minggu'};
  $('ks-form-title').textContent='Tambah Kegiatan ‚Äî '+names[id];
  renderSeksiKegList(id);
}
async function saveKegiatanSeksi(){
  const id=$('ks-select').value;
  if(!id){toast('Pilih seksi dahulu!',false);return;}
  const judul=$('ks-judul').value.trim(),tgl=$('ks-tgl').value;
  if(!judul||!tgl){toast('Judul dan tanggal wajib diisi!',false);return;}
  const item={id:Date.now(),judul,tgl,waktu:$('ks-waktu').value,lokasi:$('ks-lokasi').value.trim(),desc:$('ks-desc').value.trim(),foto:photoData.seksi||null};
  await DB.addItem('kegiatan_seksi_'+id,item);
  toast('Kegiatan berhasil disimpan!');
  clearKegForm('seksi');renderSeksiKegList(id);
}
async function renderSeksiKegList(id){
  const list=await DB.getList('kegiatan_seksi_'+id);
  const el=$('ks-list');
  if(!list.length){el.innerHTML='<div style="color:var(--text-muted);font-style:italic;padding:20px 0;">Belum ada kegiatan untuk seksi ini.</div>';return;}
  el.innerHTML=list.map(k=>`
    <div class="item-card">
      ${k.foto?`<img src="${k.foto}" class="item-thumb" alt="">`:`<div class="item-thumb-empty">üì∑</div>`}
      <div>
        <div class="item-date">${fmtDate(k.tgl)} ${k.waktu?'¬∑ '+k.waktu:''}</div>
        <div class="item-title">${k.judul}</div>
        <div class="item-meta">${k.lokasi?'üìç '+k.lokasi:''} ${k.desc?'‚Äî '+k.desc.substring(0,60)+(k.desc.length>60?'...':''):''}</div>
      </div>
      <div class="item-actions"><button class="btn-danger" onclick="delSeksiKeg('${id}','${k.id}')">Hapus</button></div>
    </div>`).join('');
}
async function delSeksiKeg(seksiId,itemId){
  if(!confirm('Hapus kegiatan ini?'))return;
  await DB.deleteItem('kegiatan_seksi_'+seksiId,itemId);
  renderSeksiKegList(seksiId);toast('Kegiatan dihapus.');
}

/* ‚ïê‚ïê‚ïê PENGURUS RESORT ‚Äî Firebase ‚ïê‚ïê‚ïê */
async function savePengurus(){
  const jabatan=$('pg-jabatan').value.trim(),nama=$('pg-nama').value.trim();
  if(!jabatan||!nama){toast('Jabatan dan nama wajib diisi!',false);return;}
  const item={id:Date.now(),jabatan,nama,telp:$('pg-telp').value.trim(),asal:$('pg-asal').value.trim(),periode:$('pg-periode').value.trim(),urutan:parseInt($('pg-urutan').value)||999,foto:photoData.pengurus||null};
  await DB.addItem('pengurus_resort',item);
  clearPengurusForm();loadPengurus();loadDashStats();toast('Pengurus berhasil ditambahkan!');
}
async function loadPengurus(){
  const list=await DB.getList('pengurus_resort');
  list.sort((a,b)=>(a.urutan||999)-(b.urutan||999));
  const grid=$('pg-grid');
  if(!list.length){grid.innerHTML='<div style="color:var(--text-muted);font-style:italic;padding:20px 0;grid-column:1/-1;">Belum ada data pengurus.</div>';return;}
  grid.innerHTML=list.map(p=>`
    <div class="pengurus-card-admin">
      <div class="pengurus-photo">
        ${p.foto?`<img src="${p.foto}" alt="${p.nama}">`:`<div class="pengurus-photo-initial">${p.nama.charAt(0)}</div>`}
      </div>
      <div class="pengurus-jabatan">${p.jabatan}</div>
      <div class="pengurus-nama">${p.nama}</div>
      ${p.asal?`<div class="pengurus-info">üìç ${p.asal}</div>`:''}
      ${p.telp?`<div class="pengurus-info">üìû ${p.telp}</div>`:''}
      ${p.periode?`<div class="pengurus-info">üìÖ ${p.periode}</div>`:''}
      <div class="pengurus-actions"><button class="btn-danger" onclick="delPengurus('${p.id}')">Hapus</button></div>
    </div>`).join('');
}
async function delPengurus(id){
  if(!confirm('Hapus pengurus ini?'))return;
  await DB.deleteItem('pengurus_resort',id);
  loadPengurus();loadDashStats();toast('Pengurus dihapus.');
}

/* ‚ïê‚ïê‚ïê FILE UNDUHAN ‚Äî Firebase ‚ïê‚ïê‚ïê */
function loadFiles(){
  const id=$('file-seksi-select').value;
  $('file-upload-wrap').style.display=id?'block':'none';
  if(!id)return;
  // Tampilkan status storage
  showStorageStatus();
  renderFilesAdmin(id);
}

function showStorageStatus() {
  const bar = $('storage-status-bar');
  if (!bar) return;
  bar.style.display = 'block';
  if (STORAGE.isReady()) {
    bar.style.background = '#d1fae5';
    bar.style.color = '#065f46';
    bar.style.border = '1px solid #6ee7b7';
    bar.innerHTML = '‚òÅÔ∏è <strong>Firebase Storage aktif</strong> ‚Äî File akan disimpan di cloud dan bisa diakses dari perangkat mana pun.';
  } else {
    bar.style.background = '#fef3c7';
    bar.style.color = '#92400e';
    bar.style.border = '1px solid #fcd34d';
    bar.innerHTML = '‚ö†Ô∏è <strong>Firebase Storage belum dikonfigurasi</strong> ‚Äî File sementara disimpan di browser lokal. <a href="#" onclick="showPanel(\'settings\',null)" style="color:#b45309;font-weight:600;">Lihat cara setup ‚Üí</a>';
  }
}

/* ‚ïê‚ïê‚ïê FILE STORAGE ‚Äî Firebase Storage + Firestore metadata ‚ïê‚ïê‚ïê */
function handleAdminUpload(event){
  const id=$('file-seksi-select').value;if(!id)return;
  const files=Array.from(event.target.files);
  const MAX_FILE = 20*1024*1024; // 20 MB
  // Upload satu per satu secara berurutan
  (async () => {
    for (const file of files) {
      if(file.size>MAX_FILE){toast('‚ùå '+file.name+' melebihi 20 MB',false);continue;}
      // Tampilkan progress bar
      const pw=$('upload-progress-wrap');
      const pl=$('upload-progress-label');
      const pp=$('upload-progress-pct');
      const pb=$('upload-progress-bar');
      if(pw){pw.style.display='block';}
      if(pl) pl.textContent='Mengupload '+file.name+'...';
      if(pp) pp.textContent='0%';
      if(pb) pb.style.width='0%';
      try {
        await STORAGE.uploadFile(id, file, pct => {
          if(pp) pp.textContent = pct+'%';
          if(pb) pb.style.width = pct+'%';
        });
        if(pw){pw.style.display='none';}
        renderFilesAdmin(id);
        loadDashStats();
        toast('‚úÖ '+file.name+' berhasil diunggah!');
      } catch(e) {
        if(pw){pw.style.display='none';}
        if (e.message && e.message.includes('storage/unauthorized')) {
          toast('‚ùå Akses ditolak ‚Äî aktifkan Firebase Storage Rules dulu. Lihat panduan setup.',false);
        } else if (e.message && e.message.includes('localStorage penuh')) {
          toast('‚ùå Penyimpanan browser penuh. Hapus beberapa file atau aktifkan Firebase Storage.',false);
        } else {
          toast('‚ùå Gagal upload: '+e.message,false);
        }
        console.error('Upload error:', e);
      }
    }
  })();
  event.target.value='';
}

async function renderFilesAdmin(id){
  const files = await STORAGE.getFiles(id);
  const el=$('file-list-admin');
  if(!el) return;
  if(!files.length){el.innerHTML='<div style="color:var(--text-muted);font-style:italic;padding:16px 0;">Belum ada file untuk seksi ini.</div>';return;}
  el.innerHTML=files.map(f=>`
    <div class="fa-item">
      <div class="fa-icon">${fileIcon(f.type)}</div>
      <div class="fa-info">
        <div class="fa-name">${f.name}</div>
        <div class="fa-meta">${f.size} ¬∑ ${f.date} ${f.url ? '¬∑ <span style="color:#059669;font-size:11px;">‚òÅÔ∏è Cloud</span>' : '¬∑ <span style="color:#d97706;font-size:11px;">üíæ Lokal</span>'}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <a href="${f.url||f.data||'#'}" target="_blank" style="font-size:12px;color:var(--navy);text-decoration:none;border:1px solid var(--navy);border-radius:5px;padding:5px 10px;">üëÅ Lihat</a>
        <button class="fa-del" onclick="delFile('${id}','${f.id}','${f.path||''}')" title="Hapus">üóëÔ∏è</button>
      </div>
    </div>`).join('');
}

async function delFile(seksiId,fileId,filePath){
  if(!confirm('Hapus file ini?'))return;
  await STORAGE.deleteFile(seksiId, fileId, filePath||null);
  renderFilesAdmin(seksiId);loadDashStats();toast('File dihapus.');
}

/* ‚ïê‚ïê‚ïê SEKRETARIAT ‚Äî Firebase ‚ïê‚ïê‚ïê */
async function loadSekretariatForm(){
  const sk=await DB.getDoc('sekretariat');
  if(sk.alamat)$('sek-alamat').value=sk.alamat;
  if(sk.telp)$('sek-telp').value=sk.telp;
  if(sk.email)$('sek-email').value=sk.email;
  if(sk.jam)$('sek-jam').value=sk.jam;
}
async function saveSekretariat(){
  const sk={alamat:$('sek-alamat').value.trim(),telp:$('sek-telp').value.trim(),email:$('sek-email').value.trim(),jam:$('sek-jam').value.trim()};
  await DB.setDoc('sekretariat',sk);
  const al=$('sek-alert');al.classList.add('show');setTimeout(()=>al.classList.remove('show'),3000);
  toast('Informasi sekretariat disimpan!');
}

/* ‚ïê‚ïê‚ïê PASSWORD CHANGE ‚ïê‚ïê‚ïê */
async function changePassword(){
  const old=$('pass-old').value,nw=$('pass-new').value,cf=$('pass-confirm').value;
  if(nw.length<6){toast('Password baru minimal 6 karakter!',false);return;}
  if(nw!==cf){toast('Konfirmasi password tidak cocok!',false);return;}
  const ok = await AUTH.changePassword(old,nw);
  if(!ok){toast('Password lama salah!',false);return;}
  ['pass-old','pass-new','pass-confirm'].forEach(i=>$(i).value='');
  const al=$('pass-alert');al.classList.add('show');setTimeout(()=>al.classList.remove('show'),3000);
  toast('‚úÖ Password berhasil diperbarui! Berlaku di semua perangkat.');
}

/* ‚ïê‚ïê‚ïê DASHBOARD STATS ‚Äî Firebase ‚ïê‚ïê‚ïê */
async function loadDashStats(){
  const kr=(await DB.getList('kegiatan_resort')).length;
  const pg=(await DB.getList('pengurus_resort')).length;
  let kj=0;
  for(const id of ['kampung-durian','krakatau','martubung','belawan','batang-sere']){
    kj+=(await DB.getList('kegiatan_jemaat_'+id)).length;
  }
  let fl = 0;
  for(const id of ['bapa','inang','namaposo','sekolah-minggu']){
    fl += (await STORAGE.getFiles(id)).length;
  }
  $('stat-keg-resort').textContent=kr;
  $('stat-keg-jemaat').textContent=kj;
  $('stat-files').textContent=fl;
  $('stat-pengurus').textContent=pg;

  // Load visitor stats for dashboard
  try {
    const totalV = await DB.getCounter('total_visitors');
    const todayKey = 'visitors_' + new Date().toLocaleDateString('id-ID',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g,'-');
    const todayV = await DB.getCounter(todayKey);
    if($('stat-visitors-total')) $('stat-visitors-total').textContent = totalV.toLocaleString('id-ID');
    if($('stat-visitors-today')) $('stat-visitors-today').textContent = todayV.toLocaleString('id-ID');
  } catch(e) {}
}

/* ‚ïê‚ïê‚ïê VISITOR STATISTICS PANEL ‚ïê‚ïê‚ïê */
async function loadVisitorStats() {
  try {
    const logs = await DB.getList('visitor_log');
    const total = await DB.getCounter('total_visitors');
    const today = new Date().toLocaleDateString('id-ID',{year:'numeric',month:'2-digit',day:'2-digit'});
    const todayKey = 'visitors_' + today.replace(/\//g,'-');
    const todayCount = await DB.getCounter(todayKey);

    // 7 days
    let weekCount = 0;
    const now = Date.now();
    const weekAgo = now - 7*24*60*60*1000;
    const uniqueIds = new Set();
    logs.forEach(l => {
      if (l.timestamp >= weekAgo) weekCount++;
      if (l.visitorId) uniqueIds.add(l.visitorId);
    });

    if($('vis-total')) $('vis-total').textContent = total.toLocaleString('id-ID');
    if($('vis-today')) $('vis-today').textContent = todayCount.toLocaleString('id-ID');
    if($('vis-week')) $('vis-week').textContent = weekCount.toLocaleString('id-ID');
    if($('vis-unique')) $('vis-unique').textContent = uniqueIds.size.toLocaleString('id-ID');

    // Top pages
    const pageCounts = {};
    logs.forEach(l => { pageCounts[l.page] = (pageCounts[l.page]||0)+1; });
    const sortedPages = Object.entries(pageCounts).sort((a,b)=>b[1]-a[1]).slice(0,6);
    const maxPage = sortedPages[0] ? sortedPages[0][1] : 1;
    if($('vis-top-pages')) {
      $('vis-top-pages').innerHTML = sortedPages.length > 0 ? sortedPages.map(([page,count])=>`
        <div style="margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;">
            <span style="color:var(--dark);">${page}</span>
            <span style="font-weight:600;color:var(--navy);">${count}</span>
          </div>
          <div style="height:6px;background:var(--parchment2);border-radius:3px;">
            <div style="height:6px;background:var(--navy);border-radius:3px;width:${Math.round(count/maxPage*100)}%;"></div>
          </div>
        </div>`).join('') : '<em style="color:var(--text-muted)">Belum ada data</em>';
    }

    // Devices
    const devCounts = {};
    logs.forEach(l => { devCounts[l.device] = (devCounts[l.device]||0)+1; });
    const DEVICE_ICONS = { Desktop:'üñ•Ô∏è', Mobile:'üì±', Tablet:'üìü' };
    if($('vis-devices')) {
      $('vis-devices').innerHTML = Object.entries(devCounts).length > 0
        ? Object.entries(devCounts).map(([dev,count])=>`
          <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--parchment2);">
            <span>${DEVICE_ICONS[dev]||'üíª'} ${dev}</span>
            <span style="font-weight:700;color:var(--navy);">${count}</span>
          </div>`).join('')
        : '<em style="color:var(--text-muted)">Belum ada data</em>';
    }

    // Log table (terbaru 50)
    const tbody = $('vis-log-tbody');
    if (tbody) {
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding:24px;text-align:center;color:var(--text-muted);font-style:italic;">Belum ada data kunjungan</td></tr>';
      } else {
        tbody.innerHTML = logs.slice(0,50).map(l=>`
          <tr style="border-bottom:1px solid var(--parchment2);">
            <td style="padding:10px 16px;">${l.date||'‚Äì'} ${l.time||''}</td>
            <td style="padding:10px 16px;">${l.page||'‚Äì'}</td>
            <td style="padding:10px 16px;">${DEVICE_ICONS[l.device]||'üíª'} ${l.device||'‚Äì'}</td>
            <td style="padding:10px 16px;">${l.browser||'‚Äì'}</td>
            <td style="padding:10px 16px;font-family:monospace;font-size:11px;color:var(--text-muted);">${(l.visitorId||'‚Äì').substr(0,18)}...</td>
          </tr>`).join('');
      }
    }
  } catch(e) {
    console.error('Gagal load visitor stats:', e);
  }
}

async function clearVisitorLog() {
  if (!confirm('Hapus semua log kunjungan? Counter total tidak akan dihapus.')) return;
  try {
    const logs = await DB.getList('visitor_log');
    for (const l of logs) await DB.deleteItem('visitor_log', l.id);
    showToast('‚úÖ Log kunjungan berhasil dihapus');
    loadVisitorStats();
  } catch(e) { showToast('‚ùå Gagal hapus log'); }
}

// Drag & drop
const dz=document.getElementById('file-drop-zone');
if(dz){
  ['dragenter','dragover'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.add('drag');}));
  ['dragleave','drop'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.remove('drag');}));
  dz.addEventListener('drop',e=>{if(e.dataTransfer&&e.dataTransfer.files.length)handleAdminUpload({target:{files:e.dataTransfer.files,value:''}});});
}
</script>
</body>
</html>
